{"version":3,"sources":["../js6/learn.js"],"names":["h","Component","render","window","preact","$","document","ready","$_URL","lvl","course","levels","Object","freeze","type","thing","sendresults","session","getElementById","fn","random","randomIndex","Math","floor","length","Array","prototype","randomize","arr","c","rnd","fromKeyCode","key","String","fromCharCode","Timer","maxTime","remainingTime","lastUpdate","target","interval","callback","stop","time","Date","now","clearInterval","start","setInterval","tick","bind","get_time","css","percent","Learn","constructor","props","state","i","n","data","error","screen","recap","num_scheduled_correct","num_scheduled","points","hearts","speed_bonus","level","maxlevel","level_type","get_all","split","map","parseInt","setChoices","componentDidMount","body","addEventListener","e","tagName","classList","contains","remove","parentNode","style","minHeight","height","on","handle_submit","previousElementSibling","value","innerHTML","focus","parent","className","getAttribute","add","id","removeChild","multiple_choice","currentTarget","audioPlayer","play","call","lastElementChild","pause","getData","onbeforeunload","warnbeforeunload","langSource","source","language_code","langTarget","keyup","componentDidUpdate","prevProps","prevState","init","imgZoom","reset","trigger","TTS","each","src","get_audio","innerText","firstElementChild","nodeName","audio","createElement","appendChild","name","time_over","setState","debug_screen","url","ajax","success","boxes","xhr","status","console","statusText","msg","event","returnValue","which","click","expectChoice","char","choices","getNext","choice","val","chosen","push","tapping_choice","idx","attributes","choice_feedback","score","isValid","kind","answerType","text","testText","sanitizeTyping","trim","is_strict","toLowerCase","refText","s","get_score","ref","entry","join","time_spent","learnable_id","calculate_points_learn","thingusers","find","item","streak","current_streak","calculate_points_review","calculate_speed_bonus","template","calculate_points_speed","register","assign","count","right","pos","keys","show_correct","append","i18n","no_more_hearts","urlFrom","return","location","href","replay","setTimeout","removeClass","correct","addClass","j","method","headers","csrftoken","referer","box_template","course_id","fully_grow","given_answer","session_end","bonus_points","calculate_accuracy_bonus","learnable_ids","session_type","total_points","indexOf","_403","login","render_presentation","markdown","addStats","next","ceil","addBoxDebugMenu","screen_template_map","current","typing","reversed_multiple_choice","audio_multiple_choice","tapping","prompt","video","presentation","render_tpl","promptWith","learn_session_level","num_choices","difficulty","taping","setting","render_multiple_choice","render_typing","render_reversed_multiple_choice","render_audio_multiple_choice","render_tapping","render_copytyping","get_screen","tpl","nChoice","items","values","decode","eval","__html","Value","content","attrs","lang","k","single","media","normal","Correction","correct_answer","wrong_answer","your_answer_was","your_answer_was_empty","near_answer","diff","Presentation","label","alternatives","txt","definition","visible_info","it","hidden_info","answer","letter","get_prompt_type","image","MultipleChoice","itemType","choicesRnd","slice","isArr","isArray","rightAnswers","includes","ChoiceBox","Typing","Tapping","remains","filter","extra","min","max","splice","word","Recap","rate","successRate","response","FIRST_LETTER_WEIGHT","DISTANCE_WEIGHT","both_are_numeric","isNumeric","get_tolerance","t","get_numeric_score","get_string_score","tolerance","distance","r","charAt","a","b","calculate_distance_matrix","get_item_at","matrix","RegexUnicode","strict","replace","RegExp","C","P","S","round","pow","percent_correct","rotate","len","res","getMatchingSubstring","l","m","match","cd","fis","mtc","sbs","getChanges","p","isThisLonger","longer","shorter","base_index","fil","sub","rc","del","ins","txt1","txt2","nextTxt2","nextTxt1","result"],"mappings":"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","file":"learn.js","sourcesContent":["/** @jsx h */\n'use strict';\nconst {h, Component, render} = window.preact;\n\n/* global $ */\n$(document).ready(function(){\n  if(window.$_URL.lvl == \"\") {\n    window.course.levels[1] = {\"name\": \"\", \"type\": 1};\n  }\n  Object.freeze(window.course);\n  render(<Learn\n            level={window.$_URL.lvl} type={window.$_URL.type}\n            thing={window.$_URL.thing}\n            sendresults={window.$_URL.sendresults} session={window.$_URL.session} />, document.getElementById('learn-container'));\n});\n\n//+--------------------------------------------------------\n//| Helper functions\n//+--------------------------------------------------------\n\n$.fn.random = function() {\n  var randomIndex = Math.floor(Math.random() * this.length);\n  return $(this[randomIndex]);\n};\nArray.prototype.random = function(){\n  var randomIndex = Math.floor(Math.random() * this.length);\n  return this[randomIndex];\n};\n\nfunction randomize(arr){\n var c = arr.length, rnd;\n\n while(c){\n  rnd = Math.random() * c-- | 0;\n  [arr[c], arr[rnd]] = [arr[rnd], arr[c]];\n }\n return arr;\n}\n\nfunction fromKeyCode(key) {\n  return String.fromCharCode((96 <= key && key <= 105)? key-48 : key);\n}\n\n//+--------------------------------------------------------\n//| Speed review timer\n//+--------------------------------------------------------\n\nvar Timer = {\n  maxTime: 6e3,\n  remainingTime: 0,\n  lastUpdate: null,\n  target: null,\n  interval: null,\n  callback: null,\n\n  stop: function(){\n    var time = Date.now();\n\n    Timer.interval && clearInterval(Timer.interval);\n    Timer.remainingTime -= (time - Timer.lastUpdate);\n    Timer.lastUpdate     = time;\n  },\n  start: function(callback){\n    Timer.callback      = callback;\n    Timer.remainingTime = Timer.maxTime;\n    Timer.lastUpdate    = Date.now();\n    Timer.interval      = setInterval(Timer.tick.bind(this), 150);\n  },\n  get_time: function(){\n    return Timer.maxTime - Timer.remainingTime;\n  },\n  tick: function(){\n    var time = Date.now();\n\n    Timer.remainingTime -= (time - Timer.lastUpdate);\n    Timer.lastUpdate     = time;\n\n    if(Timer.remainingTime <= 0) {\n      clearInterval(Timer.interval);\n      $('#speed_review-timer').css(\"height\", '100%');\n\n      Timer.callback && Timer.callback();\n    } else {\n      var percent = 1 - (Timer.remainingTime / Timer.maxTime);\n      $('#speed_review-timer').css(\"height\", (percent * 100) + '%');\n    }\n  }\n};\n\n//+--------------------------------------------------------\n//| Render game\n//+--------------------------------------------------------\n\nclass Learn extends Component {\n  state = {\n    i: 0, n: 0,\n    data: false,\n    error: false,\n    screen: false,\n    recap: {}, num_scheduled_correct: 0, num_scheduled: 0,\n    points: 0, hearts: 3, speed_bonus: 0,\n    level: 1, maxlevel: 1, level_type: 1,\n    get_all: false\n  };\n\n  //+--------------------------------------------------------\n  //| LIFECYCLE\n  //+--------------------------------------------------------\n\n  // Constructor\n  constructor(props) {\n    super(props);\n\n    if(typeof this.props.level ==\"string\") { // all\n      this.levels         = this.props.level.split(',').map((i) => parseInt(i));\n\n      this.state.level    = this.levels[0] || 1;\n      this.state.maxlevel = this.levels[this.levels.length-1] || 1;\n      this.state.get_all  = (this.props.type != \"preview\");\n    } else {\n      this.state.level    = parseInt(this.props.level);\n      this.state.maxlevel = parseInt(this.props.level);\n    }\n\n    this.setChoices = this.setChoices.bind(this);\n  }\n\n  // Initialization: retrieve datas via AJAX then bind events\n  componentDidMount() {\n\n    document.body.addEventListener('load', function(e){\n      if(e.target.tagName == 'IMG' && e.target.classList.contains('loading')){\n        e.target.classList.remove('loading');\n        e.target.parentNode.style.minHeight = e.target.height + 'px';\n      }\n    }, true); // <-- useCapture\n\n    // Submit\n    $('main').on('click', '.submit', function(e){\n      this.handle_submit(e);\n    }.bind(this));\n\n    // Typing\n    $('main').on('click', '.typing .button', function(){\n      this.parentNode.previousElementSibling.value += this.innerHTML;\n      this.parentNode.previousElementSibling.focus();\n    });\n\n    // Tapping\n    $('main').on('click', '.tapping .button', function(){\n      var parent = this.parentNode;\n\n      if(parent.className == \"keyboard\") {\n        parent.previousElementSibling.innerHTML += '<button class=\"button\" data-id=\"' + this.getAttribute('id') + '\">' + this.innerHTML + '</button>';\n        this.classList.add('disabled');\n\n      } else {\n        var id = this.getAttribute('data-id');\n        document.getElementById(id).classList.remove('disabled');\n        parent.removeChild(this);\n      }\n    });\n\n    // Multiple choice\n    $('main').on('click', '.choice-box', function(e){\n      this.multiple_choice(e.currentTarget.getAttribute('accesskey'));\n    }.bind(this));\n\n    $('main').on('mouseover focus', '.choice-box.audio', function(e){\n      window.audioPlayer && window.audioPlayer.play.call(this.lastElementChild, e, true);\n\n    }).on('mouseleave', '.choice-box.audio', function(){\n      window.audioPlayer && window.audioPlayer.pause.call(this.lastElementChild);\n    });\n\n    // Retrieve data\n    this.getData(this.state.level, function(data){\n      if(!this.props.thing) {\n        window.onbeforeunload = this.warnbeforeunload.bind(this);\n      }\n\n      if(data.session) {\n        this.langSource = data.session.course.source.language_code;\n        this.langTarget = data.session.course.target.language_code;\n      }\n\n      // Listen to keyboard inputs: next screen, multiple choice\n      $(window).on('keyup', this.keyup.bind(this));\n\n    }.bind(this));\n  }\n\n  // Every time screen gets updated\n  componentDidUpdate(prevProps, prevState) {\n    if(!this.init) {\n      this.init = true;\n    }\n    $('input[autofocus]').focus();\n\n    // Reset image zoom and audio player\n    window.imgZoom     && window.imgZoom.reset();\n    window.audioPlayer && window.audioPlayer.reset();\n\n    // Automatically play first audio\n    $('.autoplay .audio .audio-player').random().trigger(\"click\");\n\n    // Add text To Speech\n    if(window.TTS) {\n      $('.text[lang]').each(function(){\n        var src = window.TTS.get_audio(this.innerText, this.getAttribute('lang'));\n\n        if(src) {\n          if(this.firstElementChild && this.firstElementChild.nodeName == \"AUDIO\") {\n            this.firstElementChild.src = src;\n\n          } else {\n            var audio = document.createElement('audio');\n            audio.src = src;\n            audio.className = \"audio-player ico ico-audio\";\n\n            this.appendChild(audio);\n          }\n        }\n      });\n    }\n\n    // Update level title\n    if(!this.state.get_all) {\n      if(!prevState.data || prevState.level != this.state.level) {\n        var name = window.course.levels[this.state.level].name;\n        document.getElementById('level-title').innerHTML = this.state.level + (name ? \" - \" + name : \"\");\n      }\n    } else if(this.props.type == \"speed_review\"){\n      Timer.start(this.time_over.bind(this));\n    }\n\n    // Debug screen\n    $('#debug-screen').on('click', 'li', function(e){\n      if(e.target.classList.contains(\"disabled\")) return;\n\n      this.setState({\n        debug_screen: e.target.innerHTML == \"default\" ? false : e.target.innerHTML\n      });\n    }.bind(this));\n  }\n\n  // Retrieve the current level datas\n  getData(level, callback) {\n    var level_type = window.course.levels[level].type,\n        url        = '/ajax' + window.course.url;\n\n    if(this.state.get_all) {\n      url += 'all/' + this.props.type;\n    } else if(level_type == 2) {\n      url += level + '/media';\n    } else {\n      url += level + '/' + this.props.type;\n    }\n\n    $.ajax({\n      url: url,\n      data: { session: this.props.session },\n      success: function(data){\n        callback && callback(data);\n\n        this.setState({\n          recap: {},\n          screen: false,\n          error: false,\n          level: level,\n          level_type : level_type,\n\n          data : data,\n          i    : 0,\n          n    : (data.boxes ? data.boxes.length : 1)\n        });\n      }.bind(this),\n\n      error: function(xhr) {\n        if(xhr.status == 403) {\n          this.setState({error: 403 });\n        } else {\n          console.error(xhr.status + \" \" + xhr.statusText);\n          this.setState({error: 500 });\n        }\n      }.bind(this)\n    });\n  }\n\n  //+--------------------------------------------------------\n  //| EVENTS\n  //+--------------------------------------------------------\n\n  // Trigger warning when user closes tab\n  warnbeforeunload(e) {\n    if(this.state.screen == \"recap\" || this.state.error) return;\n    var msg = 'Your changes will be lost.';\n\n    e = e || window.event;\n    if (e) { // IE, Firefox < 4\n      e.returnValue = msg;\n    }\n    return msg;\n  }\n\n  // Listen to keyboard inputs: next screen, multiple choice answer\n  keyup(e) {\n    var key = e.which;\n\n    // Press enter\n    if(key == 13) {\n      if(e.target.classList.contains(\"button\") || e.target.classList.contains(\"choice-box\")) {\n        if(!e.target.classList.contains(\"disabled\")) {\n          e.target.click();\n        }\n        return;\n      }\n      this.handle_submit(e);\n\n    // Multiplice choice: press a number\n    } else if(this.expectChoice == \"numeric\" && key > 96 && key <= 105) {\n      var char = parseInt(fromKeyCode(key));\n\n      if(char <= this.choices.length) {\n        this.multiple_choice(char);\n      }\n    }\n  }\n\n  handle_submit(e) {\n\n    // Presentation\n    if(!this.expectChoice) {\n      this.getNext();\n\n    // Typing\n    } else if(this.expectChoice == \"text\") {\n      this.choice($('.typing input').val() || \"\");\n\n    // Tapping\n    } else if(this.expectChoice == \"tapping\") {\n      var chosen = [];\n      $('.tapping .input button').each(function(){\n        chosen.push(this.innerHTML);\n      });\n      this.tapping_choice(chosen);\n    }\n  }\n\n  //+--------------------------------------------------------\n  //| GAME COMPUTATIONS\n  //+--------------------------------------------------------\n\n  // Multiple choice: User chooses a answer\n  multiple_choice(i) {\n    if(this.state.screen == \"lost\") {\n      return;\n    }\n    Timer.stop();\n\n    // Check if we got the right answer\n    var idx    = parseInt(i)-1,\n        choice = this.choices[idx].attributes;\n\n    // getNormalPoints, getSpeedPoints\n    this.choice_feedback({\n      value: choice.value,\n      score: choice.isValid ? 1 : 0,\n      kind : choice.answerType,\n      i    : idx\n    });\n  }\n\n  time_over() {\n    this.choice_feedback({\n      value: \"\",\n      score: 0,\n      kind : \"\"\n    });\n  }\n\n  // Text entry: User submit its answer\n  choice(text) {\n\n    var score      = 0,\n        testText   = sanitizeTyping(text.trim(), this.is_strict).toLowerCase(),\n        refText    = \"\";\n\n    // Text input\n    for(let i=0; i<this.choices.length; i++) {\n      var choice = this.choices[i].toLowerCase().trim(),\n          s      = get_score(testText, choice);\n\n      if(s && s > score) {\n        score   = s;\n        refText = choice;\n      }\n    }\n\n    this.choice_feedback({\n      value: testText,\n      ref  : refText,\n      score: score,\n      kind : \"text\"\n    });\n  }\n\n  // Tapping: User order words\n  tapping_choice(entry) {\n    var isValid = 0;\n    entry = entry.join(\" \").trim();\n\n    for(var i=0; i<this.choices.length; i++) {\n      if(entry == this.choices[i].join(\" \").trim()) {\n        isValid = 1;\n        break;\n      }\n    }\n\n    this.choice_feedback({\n      value: entry,\n      score: isValid ? 1 : 0,\n      kind : \"text\"\n    });\n  }\n\n  // Answer has been submitted and checked: give feedback\n  choice_feedback(data) {\n    var points      = 0,\n        speed_bonus = 0,\n        time_spent  = 0,\n        id          = this.state.data.boxes[this.state.i].learnable_id;\n\n    // Score\n    switch(this.props.type){\n      case \"learn\":\n        points = calculate_points_learn(data.score);\n        break;\n\n      case \"classic_review\":\n        var thing  = this.state.data.thingusers.find((item) => item.learnable_id == id),\n            streak = 0;\n\n        if(thing) {\n          streak = thing.current_streak;\n\n          if(data.score == 1) {\n            thing.current_streak++;\n          }\n        }\n\n        points = calculate_points_learn(data.score);\n        if(streak) {\n          points = calculate_points_review(points, streak);\n        }\n        if(data.score == 1 && time_spent) {\n          speed_bonus = calculate_speed_bonus(time_spent, this.template);\n        }\n        break;\n\n      case \"speed_review\":\n        time_spent = Timer.get_time();\n\n        if(data.score == 1) {\n          points = calculate_points_speed(time_spent);\n\n        } else if(this.state.hearts) {\n          this.state.hearts -= 1;\n        }\n        break;\n    }\n    this.props.sendresults && this.register(data, id, points, data.score, time_spent);\n\n    // Count right and wrong answers\n    var recap = Object.assign({}, this.state.recap);\n    if(!recap[id]) {\n      recap[id] = {count: 0, right: 0, pos: Object.keys(recap).length};\n    }\n    recap[id].count++;\n    if(data.score == 1) {\n      recap[id].right++;\n    }\n\n    // Display correction\n    if(this.props.type == \"speed_review\") {\n      this.show_correct(data);\n\n      if(this.state.hearts == 0) {\n        this.state.screen = \"lost\";\n        this.state.error  = 1;\n\n        $(document.body).append(`<div class=\"overlay\">\n          <div class=\"no-heart\"></div>\n          <p class=\"overlay-text\">${window.i18n.no_more_hearts} !</p>\n          <div class=\"btn-group\">\n            <a href=\"${window.$_URL.urlFrom}\">${window.i18n.return}</a>\n            <a href=\"${window.location.href}\">${window.i18n.replay}</a>\n          </div>\n        </div>`);\n\n        return;\n      }\n\n      this.expectChoice = false;\n      this.choices      = false;\n      this.state.recap  = recap;\n      this.state.points += points;\n      this.state.num_scheduled += 1;\n      if(data.score == 1) {\n        this.state.num_scheduled_correct += 1;\n      }\n\n      setTimeout(function(){\n        $(\".choice-box\").removeClass(\"correct\").removeClass(\"incorrect\");\n        this.getNext();\n      }.bind(this), 500);\n\n    } else {\n      this.setState({\n        recap: recap,\n        screen: \"correction\",\n        correct: data,\n        debug_screen: false,\n        points: this.state.points + points,\n        speed_bonus: this.state.speed_bonus + speed_bonus,\n        num_scheduled: this.state.num_scheduled + 1,\n        num_scheduled_correct: this.state.num_scheduled_correct + (data.score == 1 ? 1 : 0)\n      });\n      this.expectChoice  = false;\n      this.choices       = false;\n    }\n  }\n  show_correct(data) {\n    if(\"i\" in data) {\n      $(\"#choice-\" + (data.i+1)).addClass(data.score == 1 ? \"correct\" : \"incorrect\");\n    }\n    if(data.score != 1) {\n      for(var j=0; j<this.choices.length; j++) {\n        if(this.choices[j].attributes.isValid) {\n          $(\"#choice-\" + (j+1)).addClass(\"correct\");\n          break;\n        }\n      }\n    }\n  }\n\n  // Send progress to memrise\n  register(data, learnable_id, points, score, time_spent) {\n    $.ajax({\n      url: \"/ajax/register\",\n      method: \"POST\",\n      headers: {\n        \"X-CSRFToken\": this.state.data.csrftoken,\n        \"X-Referer\"  : this.state.data.referer\n      },\n      data: {\n        box_template: this.template,\n        course_id   : window.course.id,\n        fully_grow  : false,\n        given_answer: data.value,\n        learnable_id: learnable_id,\n        points      : points,\n        score       : score,\n        time_spent  : time_spent\n      }\n    });\n  }\n  session_end() {\n    $.ajax({\n      url: \"/ajax/session_end\",\n      method: \"POST\",\n      headers: {\n        \"X-CSRFToken\": this.state.data.csrftoken,\n        \"X-Referer\"  : this.state.data.referer\n      },\n      data: {\n        bonus_points : this.state.speed_bonus + calculate_accuracy_bonus(this.state.num_scheduled_correct / this.state.num_scheduled * 100, this.state.num_scheduled),\n        course_id    : window.course.id,\n        learnable_ids: '[\"' + Object.keys(this.state.recap).join('\",\"') + '\"]',\n        session_type : (this.props.type == \"classic_review\" ? \"review\" : this.props.type),\n        total_points : this.state.points\n      }\n    });\n  }\n\n  // Display next screen\n  getNext() {\n\n    // Next item\n    if(this.state.i + 1 < this.state.n) {\n      this.setState({\n        i: this.state.i + 1,\n        screen: false\n      });\n\n    // Next level or go back to course's page\n    } else if(this.state.screen == \"recap\" || this.state.level_type == 2){\n      if(!this.state.get_all && this.state.level < this.state.maxlevel) {\n        if(this.state.data) {\n          this.setState({\n            data: false\n          });\n          this.getData(this.levels[this.levels.indexOf(this.state.level) + 1]);\n        }\n      } else {\n        this.state.error = 1; // prevent warning\n        window.location.href = window.$_URL.urlFrom;\n      }\n\n    // Recap\n    } else {\n      this.props.sendresults && this.session_end();\n\n      this.setState({\n        i: this.state.n,\n        screen: \"recap\"\n      }, function(){\n        window.imgZoom && window.imgZoom.reset();\n      });\n    }\n  }\n\n  //+--------------------------------------------------------\n  //| RENDERING\n  //+--------------------------------------------------------\n\n  setChoices(choices, type, is_strict) {\n    this.expectChoice = type; // numeric | text\n    this.choices      = choices;\n    this.is_strict    = is_strict || 1;\n  }\n\n  render() {\n\n    // Something went wrong\n    if(this.state.error) {\n      if(this.state.error == 403) {\n        return <p>{window.i18n._403} <a href=\"/login\" class=\"link\">{window.i18n.login}</a></p>;\n      } else {\n        return <p>{window.i18n.error}</p>;\n      }\n    }\n\n    // Loading data\n    if(!this.state.data) {\n      return <div class=\"loading-spinner\"></div>;\n    }\n\n    // Preview thing\n    if(this.props.thing) {\n      if(this.state.debug_screen) {\n        return this.screen();\n      } else {\n        return <div>{/*this.addBoxDebugMenu()*/}{this.render_presentation(false)}</div>;\n      }\n    }\n\n    // Media level\n    if(this.state.level_type == 2 && !this.state.get_all) {\n      return this.markdown();\n    }\n\n    // Recap\n    if(this.state.screen == \"recap\") {\n      return <div>{this.addStats()}{this.screen()}</div>;\n    }\n\n    // Default\n    return <div>\n      {/*this.addBoxDebugMenu()*/}\n\n      {/* POINTS, HEARTS, PROGRESS BAR */}\n      {this.addStats()}\n\n      {/* SCREEN */}\n      {this.props.type == \"speed_review\"\n        ? <div class=\"speed_review\"><div id=\"speed_review-timer\" key={Date.now()}></div>{this.screen()}</div>\n        : this.screen()}\n\n      <span class=\"btn submit\" tabindex=\"0\">{window.i18n.next}</span>\n    </div>;\n  }\n\n  addStats() {\n    var percent = (this.state.n ? Math.ceil(this.state.i / this.state.n * 100) : 100);\n\n    return <div class=\"progress-stats\">\n      {this.props.type == \"speed_review\" &&\n        <div class=\"hearts-wrapper\">{[1,2,3].map((i) => <span class={\"heart \" + (i <= this.state.hearts ? \"full\" : \"empty\")}></span>)}</div>}\n      <div class=\"points-num\">{this.state.points}</div>\n\n      <div class=\"progress-bar\" role=\"progressbar\" aria-valuenow={this.state.i} aria-valuemin=\"0\" aria-valuemax={this.state.i}>\n        <div class=\"counter\">{this.state.i} / {this.state.n}</div>\n        <div class=\"progress-bar-active\" style={{'clip-path': 'polygon(0 0, '+percent+'% 0, '+percent+'% 100%, 0 100%)'}}>\n          <div class=\"counter\">{this.state.i} / {this.state.n}</div>\n        </div>\n      </div>\n    </div>;\n  }\n\n  addBoxDebugMenu() {\n    var item    = this.state.data.boxes[this.state.i],\n        screen  = this.state.data.screen_template_map[item.learnable_id],\n        current = this.state.debug_screen;\n\n    return <ul id=\"debug-screen\">\n      <li class={current ? \"\" : \"active\"}>default</li>\n      <li class={(\"multiple_choice\" in screen && screen.multiple_choice ? \"\" : \"disabled\")\n              + (current == \"multiple_choice\" ? \" active\" : \"\")}>\n        multiple_choice\n      </li>\n      <li class={(\"typing\" in screen && screen.typing ? \"\" : \"disabled\")\n              + (current == \"typing\" ? \" active\" : \"\")}>\n        typing\n      </li>\n      <li class={(\"reversed_multiple_choice\" in screen && screen.reversed_multiple_choice ? \"\" : \"disabled\")\n              + (current == \"reversed_multiple_choice\" ? \" active\" : \"\")}>\n        reversed_multiple_choice\n      </li>\n      <li class={(\"audio_multiple_choice\" in screen && screen.audio_multiple_choice ? \"\" : \"disabled\")\n              + (current == \"audio_multiple_choice\" ? \" active\" : \"\")}>\n        audio_multiple_choice\n      </li>\n      <li class={(\"tapping\" in screen && screen.tapping ? \"\" : \"disabled\")\n              + (current == \"tapping\" ? \" active\" : \"\")}>\n        tapping\n      </li>\n      <li class={(\"typing\" in screen && screen.typing ? \"\" : \"disabled\")\n              + (current == \"copytyping\" ? \" active\" : \"\")}>\n        copytyping\n      </li>\n      <li class={(\"typing\" in screen && screen.typing.audio ? \"\" : \"disabled\")\n              + (current == \"audio_typing\" ? \" active\" : \"\")}>\n        audio_typing\n      </li>\n      <li class={(\"reversed_multiple_choice\" in screen && screen.reversed_multiple_choice.prompt.video ? \"\" : \"disabled\")\n              + (current == \"reversed_multiple_choice_prompt_video\" ? \" active\" : \"\")}>\n        reversed_multiple_choice_prompt_video\n      </li>\n      <li class={(\"multiple_choice\" in screen && screen.multiple_choice.prompt.video ? \"\" : \"disabled\")\n              + (current == \"video-pre-presentation\" ? \" active\" : \"\")}>\n        video-pre-presentation\n      </li>\n      <li class={(screen.presentation ? \"\" : \"disabled\")\n              + (current == \"presentation\" ? \" active\" : \"\")}>\n        presentation\n      </li>\n    </ul>;\n  }\n\n  screen() {\n    if(this.state.debug_screen) {\n      switch(this.state.debug_screen) {\n        case \"multiple_choice\"         : return this.render_tpl({ template: \"multiple_choice\" });\n        case \"typing\"                  : return this.render_tpl({ template: \"typing\" });\n        case \"reversed_multiple_choice\": return this.render_tpl({ template: \"reversed_multiple_choice\" });\n        case \"audio_multiple_choice\"   : return this.render_tpl({ template: \"audio_multiple_choice\" });\n        case \"tapping\"                 : return this.render_tpl({ template: \"tapping\" });\n        case \"copytyping\"              : return this.render_tpl({ template: \"copytyping\" });\n        case \"audio_typing\"            : return this.render_tpl({ template: \"typing\", promptWith: \"audio\" });\n        case \"reversed_multiple_choice_prompt_video\": return this.render_tpl({ template: \"reversed_multiple_choice\", promptWith: \"video\" });\n        case \"video-pre-presentation\"  : return this.render_tpl({ template: \"multiple_choice\", promptWith: \"video\" });\n        case \"presentation\"            : return this.render_tpl({ template: \"presentation\" });\n      }\n    }\n\n    if(this.state.screen == \"recap\") {\n      return this.recap();\n    }\n    if(this.state.screen == \"correction\") {\n      return this.render_presentation(this.state.correct || true);\n    }\n\n    var item   = this.state.data.boxes[this.state.i],\n        screen = this.state.data.screen_template_map[item.learnable_id];\n\n    if(item.learn_session_level) {\n      switch(item.learn_session_level) {\n        case 1:\n            return this.render_tpl({\n              template: \"multiple_choice\",\n              num_choices: 4\n            });\n\n        case 2:\n          if(screen.multiple_choice.video) {\n            return this.render_tpl({\n              template: \"reversed_multiple_choice\",\n              num_choices: 4,\n              promptWith: \"video\"\n            });\n          }\n          if(screen.audio_multiple_choice && Math.random() > .5) {\n            return this.render_tpl({\n              template: \"audio_multiple_choice\"\n            });\n          }\n          if(screen.tapping) {\n            return this.render_tpl({\n              template: \"tapping\",\n              difficulty: 0\n            });\n          }\n          return this.render_tpl({\n            template: \"reversed_multiple_choice\",\n            num_choices: 4\n          });\n\n        case 3:\n          if(screen.tapping) {\n            return this.render_tpl({\n              template: \"tapping\",\n              difficulty: .5\n            });\n          }\n          if(screen.typing) {\n            return this.render_tpl({\n              template: \"typing\"\n            });\n          }\n          return this.render_tpl({\n            template: \"multiple_choice\",\n            num_choices: 8\n          });\n\n        case 4:\n          if(screen.multiple_choice.video) {\n            return this.render_tpl({\n              template: \"reversed_multiple_choice\",\n              num_choices: 4,\n              promptWith: \"video\"\n            });\n          }\n          if(Math.random() > .5) {\n            var s = [];\n            if(screen.typing.audio) {\n              s.push({\n                template: \"typing\",\n                promptWith: \"audio\"\n              });\n            }\n            if(screen.reversed_multiple_choice.audio) {\n              s.push({\n                template: \"reversed_multiple_choice\",\n                num_choices: 4,\n                promptWith: \"audio\"\n              });\n            }\n            if(s.length > 0) {\n              return this.render_tpl(s.random());\n            }\n          }\n          return this.render_tpl({\n            template: \"reversed_multiple_choice\",\n            num_choices: [4, 6].random()\n          });\n\n        case 5:\n          if(screen.taping) {\n            return this.render_tpl({\n              template: \"tapping\",\n              difficulty: .5\n            });\n          }\n          return this.render_tpl({\n            template: \"multiple_choice\",\n            num_choices: [6, 8].random()\n          });\n\n        default:\n          if(screen.typing) {\n            return this.render_tpl({\n              template: \"typing\"\n            });\n          }\n          return {\n            template: \"multiple_choice\",\n            num_choices: 8\n          };\n      }\n    }\n\n    if(this.props.type == \"speed_review\") {\n      return this.render_tpl({\n        template: \"multiple_choice\",\n        num_choices: 4\n      });\n    }\n    if(item.template == \"sentinel\") {\n      if(screen.typing) {\n        return this.render_tpl({\n          template: \"typing\"\n        });\n      }\n      if(screen.audio_multiple_choice && Math.random() > .5) {\n        return this.render_tpl({\n          template: \"audio_multiple_choice\"\n        });\n      }\n      return this.render_tpl({\n          template: \"multiple_choice\",\n          num_choices: 8\n      });\n    }\n\n    return this.render_tpl({ template: item.template });\n  }\n  render_tpl(setting) {\n    this.template = setting.template;\n\n    switch(setting.template) {\n      case \"multiple_choice\": return this.render_multiple_choice(setting);\n      case \"typing\": return this.render_typing(setting);\n      case \"reversed_multiple_choice\": return this.render_reversed_multiple_choice(setting);\n      case \"audio_multiple_choice\": return this.render_audio_multiple_choice(setting);\n      case \"tapping\": return this.render_tapping(setting);\n      case \"copytyping\": return this.render_copytyping(setting);\n      case \"presentation\":\n        return this.render_presentation();\n      default:\n        console.error(setting.template + \" doesn't exist\");\n    }\n  }\n  get_screen(tpl) {\n    var id = this.props.thing || this.state.data.boxes[this.state.i].learnable_id;\n    return this.state.data.screen_template_map[id][tpl][0];\n  }\n\n  render_audio_multiple_choice(setting) {\n    return <MultipleChoice\n              item={this.get_screen(\"audio_multiple_choice\")}\n              nChoice={setting.nChoice || 4}\n              promptWith={setting.promptWith}\n              setChoices={this.setChoices} />;\n  }\n  render_reversed_multiple_choice(setting) {\n    return <MultipleChoice\n              item={this.get_screen(\"reversed_multiple_choice\")}\n              nChoice={setting.nChoice || 4}\n              promptWith={setting.promptWith}\n              setChoices={this.setChoices} />;\n  }\n  render_multiple_choice(setting) {\n    return <MultipleChoice\n              item={this.get_screen(\"multiple_choice\")}\n              nChoice={setting.nChoice || (this.props.type == \"speed_review\" ? 4 : 9)}\n              promptWith={setting.promptWith}\n              setChoices={this.setChoices} />;\n  }\n  render_typing(setting) {\n    return <Typing item={this.get_screen(\"typing\")} setChoices={this.setChoices} promptWith={setting.promptWith} />;\n  }\n  render_tapping(setting) {\n    return <Tapping item={this.get_screen(\"tapping\")} difficulty={setting.difficulty || 1} setChoices={this.setChoices} />;\n  }\n  render_copytyping(){\n    var prompt = this.get_screen(\"typing\");\n    this.setChoices(prompt.correct, \"text\", prompt.is_strict);\n\n    return <Presentation item={this.get_screen(\"presentation\")} prompt={prompt} />;\n  }\n  render_presentation(correct) {\n    return <Presentation item={this.get_screen(\"presentation\")} correct={correct} langTarget={this.langTarget} />;\n  }\n  recap() {\n    var items = [];\n\n    if(this.props.type == \"preview\") {\n      for(var i=0; i<this.state.data.boxes.length; i++) {\n        var id = this.state.data.boxes[i].learnable_id;\n\n        items.push(this.state.data.screen_template_map[id].presentation[0]);\n      }\n    } else {\n      for(var id in this.state.recap) {\n        var item = this.state.recap[id];\n\n        items[item.pos] = {...item, ...this.state.data.screen_template_map[id].presentation[0]};\n      }\n    }\n    return <Recap items={Object.values(items)} type={this.props.type} />;\n  }\n  markdown() {\n    var data = window.markdown.decode(eval(this.state.data));\n    return <div class=\"nicebox\" dangerouslySetInnerHTML={{__html: data}} />;\n  }\n}\n\nconst Value = function(props) {\n  var content = props.content,\n      attrs   = {};\n  if(props.lang) {\n    attrs.lang = props.lang;\n  }\n  var k = Date.now(),\n      i = 0;\n\n  if(props.single) {\n    switch(props.type) {\n      case \"text\" : return <span>{content}</span>;\n      case \"image\": return <img key={k} src={content} class=\"text-image\" />;\n      case \"audio\": return <audio key={k} src={content} class=\"audio-player ico ico-l ico-audio\"></audio>;\n      case \"video\": return <video key={k} src={content} class=\"video-player\" controls autoplay>Your browser does not support the video tag.</video>;\n    }\n  } else {\n    switch(props.type) {\n      case \"text\" : return <div class=\"text\" {...attrs}>{content}</div>;\n      case \"image\": return <div class=\"image\"><div class=\"media-list\">{content.map(media => <img key={k + i++} src={media} class=\"text-image loading\" />)}</div></div>;\n      case \"audio\": return <div class=\"audio\"><div class=\"media-list\">{content.map(media => <audio key={k + i++} src={media.normal} class=\"audio-player ico ico-l ico-audio\"></audio>)}</div></div>;\n      case \"video\": return <div class=\"video\"><div class=\"media-list\"><video key={k + i++} src={content.random()} class=\"video-player\" controls autoplay>Your browser does not support the video tag.</video></div></div>;\n    }\n  }\n};\n\nconst Correction = function(props) {\n  var data = props.data;\n\n  if(data.score == 1) {\n    return <div class=\"alert alert-success\">{window.i18n.correct_answer}!</div>;\n\n  } else if(data.score == 0) {\n    return <div class=\"alert alert-danger\">\n      {window.i18n.wrong_answer}!&nbsp;\n      {data.value\n        ? <span>{window.i18n.your_answer_was}: <strong><Value content={data.value} type={data.kind} single=\"1\" /></strong></span>\n        : <span>{window.i18n.your_answer_was_empty}</span>}\n    </div>;\n\n  } else {\n    return <div class=\"alert alert-warning\">\n      {window.i18n.near_answer}!&nbsp;\n      <span>{window.i18n.your_answer_was}: <strong>\n        {data.kind == \"text\"\n          ? <span>{data.value} <small class=\"correction\" dangerouslySetInnerHTML={{__html: \"(\" + diff(data.value, data.ref) + \")\"}} /></span>\n          : <Value content={data.value} type={data.kind} single=\"1\" />}\n      </strong></span>\n    </div>;\n  }\n};\n\nconst Presentation = function(props){\n  var item = props.item, correct = props.correct,\n      k    = Date.now(), i = 0;\n\treturn <div>\n\n    {/*-- Correction --*/}\n    {correct && <Correction data={correct} />}\n\n    {/*-- Content --*/}\n    <table class={\"learn nicebox big thing\" + (correct ? \"\": \" autoplay\")}>\n\n        {/*-- Item --*/}\n        <tr>\n          <td class=\"label\">{item.item.label}</td>\n          <td class=\"item\">\n            <Value content={item.item.value} type={item.item.kind} lang={this.props.langTarget} />\n            {item.item.alternatives.map(txt =>\n              <div class=\"alt\">{txt}</div>\n            )}\n          </td>\n        </tr>\n\n        {/*-- Definition --*/}\n        <tr>\n          <td class=\"label\">{item.definition.label}</td>\n          <td class=\"definition\">\n            <Value content={item.definition.value} type={item.definition.kind} />\n            {item.definition.alternatives.map(txt =>\n              <div class=\"alt\">{txt}</div>\n            )}\n          </td>\n        </tr>\n        <tr class=\"sep\"><td colspan=\"2\"></td></tr>\n\n        {/*-- Audio --*/}\n        {item.audio && <tr key={k + i++}>\n          <td class=\"label\">{item.audio.label}</td>\n          <td class=\"audio\"><Value content={item.audio.value} type=\"audio\" /></td>\n        </tr>}\n\n        {/*-- Additional content --*/}\n        {item.visible_info.map(it => <tr key={k + i++}>\n          <td class=\"label\">{it.label}</td>\n          <td class=\"more\"><Value content={it.value} type={it.kind} /></td>\n        </tr>)}\n\n        {item.hidden_info.map(it => <tr key={k + i++}>\n          <td class=\"label\">{it.label}</td>\n          <td class=\"more\"><Value content={it.value} type={it.kind} /></td>\n        </tr>)}\n\n        {/*-- Attributs --*/}\n        {item.attributes.map(it => <tr key={k + i++}>\n          <td class=\"label\">{it.label}</td>\n          <td class=\"more\"><span class=\"badge\"><Value content={it.value} type=\"text\" single=\"1\" /></span></td>\n        </tr>)}\n      </table>\n\n      {/*-- Copytyping --*/}\n      {props.prompt && <div class=\"typing-container\" key={k + i++}>\n          <div class=\"typing\">\n            <input type=\"text\" autocomplete=\"off\" spellcheck=\"false\" value=\"\" placeholder={props.prompt.answer.value} tabindex=\"1\" autoFocus=\"autofocus\" />\n            <ul class=\"keyboard\">{props.prompt.choices.map((letter, i) =>\n              <li class=\"button\" tabindex={i+2}>{letter}</li>\n            )}</ul>\n          </div>\n        </div>}\n    </div>;\n};\n\nfunction get_prompt_type(item) {\n  if(item.prompt.text) return \"text\";\n  if(item.prompt.image) return \"image\";\n  if(item.prompt.audio) return \"audio\";\n  if(item.prompt.video) return \"video\";\n}\n\nconst MultipleChoice = function(props) {\n  var item       = props.item,\n      itemType   = props.promptWith || get_prompt_type(item),\n      answerType = item.answer.kind;\n\n  // Randomize choices order\n  var n          = item.choices.length,\n      choicesRnd = randomize([...item.choices]);\n\n  // Display 9 choices max\n  if(n > props.nChoice) {\n    n = props.nChoice;\n    choicesRnd = choicesRnd.slice(0, n);\n  }\n\n  // Place the right answer somewhere in it\n  var rnd    = Math.random() * n - 1 | 0,\n     isArr   = $.isArray(item.answer.value);\n\n  if(isArr) {\n    var choice = item.answer.value.random();\n    choicesRnd[rnd] = choice.normal || choice;\n  } else {\n    choicesRnd[rnd] = item.answer.value;\n  }\n\n  // Get the list of answers that are acceptable\n  var rightAnswers = [];\n  if(isArr) {\n    for(var i=0; i<item.answer.value.length; i++) {\n      choice = item.answer.value[i];\n      rightAnswers.push(choice.normal || choice);\n    }\n  } else {\n    choicesRnd[rnd] = item.answer.value;\n    rightAnswers.push(item.answer.value);\n  }\n  rightAnswers.push(...item.answer.alternatives);\n\n  // Display our boxes\n  var choices = choicesRnd.map((value, i) => {\n    return <ChoiceBox key={i} i={i+1} value={value} answerType={answerType} isValid={rightAnswers.includes(value)} />;\n  });\n  props.setChoices(choices, \"numeric\");\n\n  return <div class=\"nicebox\">\n\n    {/*-- Item --*/}\n    <div class=\"big choice autoplay\">\n      <Value content={item.prompt[itemType].value} type={itemType} />\n    </div>\n\n    {/*-- Choices --*/}\n    <div class={\"medium choices n\" + props.nChoice}>{choices}</div>\n  </div>;\n};\n\nclass ChoiceBox extends Component {\n  render(props) {\n    return <div accesskey={props.i} class={\"choice-box nicebox \" + props.answerType} id={\"choice-\" + props.i} tabindex={props.i}>\n      <span class=\"choice-index\">{props.i}.</span>\n      <Value content={props.value} type={props.answerType} single=\"1\" />\n    </div>;\n  }\n}\n\nconst Typing = function(props) {\n  var item     = props.item,\n      itemType = props.promptWith || get_prompt_type(item);\n\n  props.setChoices(item.correct, \"text\", item.is_strict);\n\n  return <div class=\"nicebox\">\n    <div class=\"big choice autoplay\">\n      <Value content={item.prompt[itemType].value} type={itemType} />\n\n      {/*-- Attributs --*/}\n      {item.attributes && <div class=\"clues\">\n        {item.attributes.map(it => <span class=\"badge\"><Value content={it.value} type=\"text\" single=\"1\" /></span>)}\n      </div>}\n    </div>\n    <div class=\"typing-container\">\n      <div class=\"typing\" key={Date.now()}>\n        <input type=\"text\" autocomplete=\"off\" spellcheck=\"false\" value=\"\" tabindex=\"1\" autoFocus=\"autofocus\" />\n        <ul class=\"keyboard\">{item.choices.map((letter, i) =>\n          <li class=\"button\" tabindex={i+2}>{letter}</li>\n        )}</ul>\n      </div>\n    </div>\n  </div>;\n};\n\nconst Tapping = function(props) {\n  var item     = props.item,\n      itemType = get_prompt_type(item);\n\n  props.setChoices(item.correct, \"tapping\", item.is_strict);\n\n  var n       = item.correct.length,\n      choices = item.correct[0].slice(),\n      remains = item.choices.filter((it) => !choices.includes(it)),\n      extra   = 0;\n\n  if(props.difficulty == 0) {\n    extra = 0;\n  } else if(n < 5){\n    extra = 6 - n;\n  } else {\n    extra = Math.min(Math.max(0, 15 - n), Math.ceil(props.difficulty * n));\n  }\n\n  for(var i=0; i<extra; i++) {\n    if(!remains.length) {\n      break;\n    }\n    var rnd = Math.floor(Math.random() * remains.length),\n        it  = remains.splice(rnd,1);\n    choices.push(...it);\n  }\n\n  return <div class=\"nicebox\">\n    <div class=\"big choice autoplay\">\n      <Value content={item.prompt[itemType].value} type={itemType} />\n\n      {/*-- Attributs --*/}\n      {item.attributes && <div class=\"clues\">\n        {item.attributes.map(it => <span class=\"badge\"><Value content={it.value} type=\"text\" single=\"1\" /></span>)}\n      </div>}\n    </div>\n    <div class=\"tapping-container\">\n      <div class=\"tapping\" key={Date.now()}>\n        <div class=\"input\"></div>\n        <ul class=\"keyboard\">{randomize(choices).map((word, i) =>\n          <li class=\"button\" tabindex={i+1} id={\"btn-\" + i}>{word}</li>\n        )}</ul>\n      </div>\n    </div>\n  </div>;\n};\n\nconst Recap = function(props) {\n  var items = props.items,\n      type  = props.type;\n\n  return <table class=\"learn nicebox recap\">\n  {items.map((item) => {\n    var rate = \"\";\n\n    // Compute success rate\n    if(type != \"preview\") {\n      var successRate = item.right / item.count * 100,\n          className   = (successRate == 100 ? \"neverMissed\" : (successRate < 20 ? \"oftenMissed\" : (successRate > 80 ? \"rarelyMissed\" : \"sometimesMissed\"))),\n          rate        = <span class={className}>{item.right}/{item.count}</span>;\n    }\n\n    // Render item\n    return <tr class=\"thing\">\n      <td><Value content={item.item.value} type={item.item.kind} /></td>\n      <td><Value content={item.definition.value} type={item.definition.kind} /></td>\n      {rate && <td>{rate}</td>}\n    </tr>})}\n  </table>;\n};\n\n//+--------------------------------------------------------\n//| SCORING SYSTEM\n//+--------------------------------------------------------\n\nfunction get_score(response, answer) {\n var FIRST_LETTER_WEIGHT = .1,\n     DISTANCE_WEIGHT = .9;\n\n  if(!response) {\n    return 0;\n  }\n  var both_are_numeric = function() {\n    return $.isNumeric(parseInt(response, 10)) && $.isNumeric(parseInt(answer, 10));\n  },\n  get_tolerance = function() {\n    var t = answer.length > 18 ? .5 : answer.length < 3 ? 1 : -1 * answer.length / 33 + 1.1;\n    return t, answer.length * t;\n  },\n  get_numeric_score = function() {\n    return (parseInt(response, 10) === parseInt(answer, 10) ? 1 : 0);\n  },\n  get_string_score = function() {\n    var tolerance = get_tolerance(),\n        n = distance(response, answer);\n    if (n >= tolerance) return 0;\n\n    var r = answer.charAt(0) === response.charAt(0) ? 1 : 0,\n        i = (tolerance - n) / tolerance,\n        s = FIRST_LETTER_WEIGHT * r + DISTANCE_WEIGHT * i;\n\n    return s < .5 && (s = 0), s;\n  };\n  return both_are_numeric() ? get_numeric_score() : get_string_score();\n}\n\nfunction distance(a, b) {\n  var calculate_distance_matrix = function() {\n    var get_item_at;\n\n    if($.isArray(a)) {\n      get_item_at = function(arr, i) { return arr[i] };\n    } else {\n      get_item_at = function(arr, i) { return arr.charAt(i) };\n    }\n\n    // Create matrix\n    var matrix = [];\n    for (var i = 0; i <= a.length; i += 1) matrix[i] = [], matrix[i][0] = i;\n    for (var j = 0; j <= b.length; j += 1) matrix[0][j] = j;\n\n    // Calculate distance\n    for (var i = 1; i <= a.length; i += 1) {\n      for (var j = 1; j <= b.length; j += 1) {\n        matrix[i][j] = Math.min(\n          matrix[i - 1][j] + 1,\n          matrix[i][j - 1] + 1,\n          matrix[i - 1][j - 1] + (get_item_at(a, i - 1) === get_item_at(b, j - 1) ? 0 : 1)\n        );\n      }\n    }\n    return matrix;\n  };\n\n  var matrix = calculate_distance_matrix();\n  return matrix[a.length][b.length];\n}\n\n// https://cdnjs.cloudflare.com/ajax/libs/xregexp/3.1.1/xregexp-all.js\nvar RegexUnicode = {\n  'C': '\\0-\\x1F\\x7F-\\x9F\\xAD\\u0378\\u0379\\u0380-\\u0383\\u038B\\u038D\\u03A2\\u0530\\u0557\\u0558\\u0560\\u0588\\u058B\\u058C\\u0590\\u05C8-\\u05CF\\u05EB-\\u05EF\\u05F5-\\u0605\\u061C\\u061D\\u06DD\\u070E\\u070F\\u074B\\u074C\\u07B2-\\u07BF\\u07FB-\\u07FF\\u082E\\u082F\\u083F\\u085C\\u085D\\u085F-\\u089F\\u08B5-\\u08E2\\u0984\\u098D\\u098E\\u0991\\u0992\\u09A9\\u09B1\\u09B3-\\u09B5\\u09BA\\u09BB\\u09C5\\u09C6\\u09C9\\u09CA\\u09CF-\\u09D6\\u09D8-\\u09DB\\u09DE\\u09E4\\u09E5\\u09FC-\\u0A00\\u0A04\\u0A0B-\\u0A0E\\u0A11\\u0A12\\u0A29\\u0A31\\u0A34\\u0A37\\u0A3A\\u0A3B\\u0A3D\\u0A43-\\u0A46\\u0A49\\u0A4A\\u0A4E-\\u0A50\\u0A52-\\u0A58\\u0A5D\\u0A5F-\\u0A65\\u0A76-\\u0A80\\u0A84\\u0A8E\\u0A92\\u0AA9\\u0AB1\\u0AB4\\u0ABA\\u0ABB\\u0AC6\\u0ACA\\u0ACE\\u0ACF\\u0AD1-\\u0ADF\\u0AE4\\u0AE5\\u0AF2-\\u0AF8\\u0AFA-\\u0B00\\u0B04\\u0B0D\\u0B0E\\u0B11\\u0B12\\u0B29\\u0B31\\u0B34\\u0B3A\\u0B3B\\u0B45\\u0B46\\u0B49\\u0B4A\\u0B4E-\\u0B55\\u0B58-\\u0B5B\\u0B5E\\u0B64\\u0B65\\u0B78-\\u0B81\\u0B84\\u0B8B-\\u0B8D\\u0B91\\u0B96-\\u0B98\\u0B9B\\u0B9D\\u0BA0-\\u0BA2\\u0BA5-\\u0BA7\\u0BAB-\\u0BAD\\u0BBA-\\u0BBD\\u0BC3-\\u0BC5\\u0BC9\\u0BCE\\u0BCF\\u0BD1-\\u0BD6\\u0BD8-\\u0BE5\\u0BFB-\\u0BFF\\u0C04\\u0C0D\\u0C11\\u0C29\\u0C3A-\\u0C3C\\u0C45\\u0C49\\u0C4E-\\u0C54\\u0C57\\u0C5B-\\u0C5F\\u0C64\\u0C65\\u0C70-\\u0C77\\u0C80\\u0C84\\u0C8D\\u0C91\\u0CA9\\u0CB4\\u0CBA\\u0CBB\\u0CC5\\u0CC9\\u0CCE-\\u0CD4\\u0CD7-\\u0CDD\\u0CDF\\u0CE4\\u0CE5\\u0CF0\\u0CF3-\\u0D00\\u0D04\\u0D0D\\u0D11\\u0D3B\\u0D3C\\u0D45\\u0D49\\u0D4F-\\u0D56\\u0D58-\\u0D5E\\u0D64\\u0D65\\u0D76-\\u0D78\\u0D80\\u0D81\\u0D84\\u0D97-\\u0D99\\u0DB2\\u0DBC\\u0DBE\\u0DBF\\u0DC7-\\u0DC9\\u0DCB-\\u0DCE\\u0DD5\\u0DD7\\u0DE0-\\u0DE5\\u0DF0\\u0DF1\\u0DF5-\\u0E00\\u0E3B-\\u0E3E\\u0E5C-\\u0E80\\u0E83\\u0E85\\u0E86\\u0E89\\u0E8B\\u0E8C\\u0E8E-\\u0E93\\u0E98\\u0EA0\\u0EA4\\u0EA6\\u0EA8\\u0EA9\\u0EAC\\u0EBA\\u0EBE\\u0EBF\\u0EC5\\u0EC7\\u0ECE\\u0ECF\\u0EDA\\u0EDB\\u0EE0-\\u0EFF\\u0F48\\u0F6D-\\u0F70\\u0F98\\u0FBD\\u0FCD\\u0FDB-\\u0FFF\\u10C6\\u10C8-\\u10CC\\u10CE\\u10CF\\u1249\\u124E\\u124F\\u1257\\u1259\\u125E\\u125F\\u1289\\u128E\\u128F\\u12B1\\u12B6\\u12B7\\u12BF\\u12C1\\u12C6\\u12C7\\u12D7\\u1311\\u1316\\u1317\\u135B\\u135C\\u137D-\\u137F\\u139A-\\u139F\\u13F6\\u13F7\\u13FE\\u13FF\\u169D-\\u169F\\u16F9-\\u16FF\\u170D\\u1715-\\u171F\\u1737-\\u173F\\u1754-\\u175F\\u176D\\u1771\\u1774-\\u177F\\u17DE\\u17DF\\u17EA-\\u17EF\\u17FA-\\u17FF\\u180E\\u180F\\u181A-\\u181F\\u1878-\\u187F\\u18AB-\\u18AF\\u18F6-\\u18FF\\u191F\\u192C-\\u192F\\u193C-\\u193F\\u1941-\\u1943\\u196E\\u196F\\u1975-\\u197F\\u19AC-\\u19AF\\u19CA-\\u19CF\\u19DB-\\u19DD\\u1A1C\\u1A1D\\u1A5F\\u1A7D\\u1A7E\\u1A8A-\\u1A8F\\u1A9A-\\u1A9F\\u1AAE\\u1AAF\\u1ABF-\\u1AFF\\u1B4C-\\u1B4F\\u1B7D-\\u1B7F\\u1BF4-\\u1BFB\\u1C38-\\u1C3A\\u1C4A-\\u1C4C\\u1C80-\\u1CBF\\u1CC8-\\u1CCF\\u1CF7\\u1CFA-\\u1CFF\\u1DF6-\\u1DFB\\u1F16\\u1F17\\u1F1E\\u1F1F\\u1F46\\u1F47\\u1F4E\\u1F4F\\u1F58\\u1F5A\\u1F5C\\u1F5E\\u1F7E\\u1F7F\\u1FB5\\u1FC5\\u1FD4\\u1FD5\\u1FDC\\u1FF0\\u1FF1\\u1FF5\\u1FFF\\u200B-\\u200F\\u202A-\\u202E\\u2060-\\u206F\\u2072\\u2073\\u208F\\u209D-\\u209F\\u20BF-\\u20CF\\u20F1-\\u20FF\\u218C-\\u218F\\u23FB-\\u23FF\\u2427-\\u243F\\u244B-\\u245F\\u2B74\\u2B75\\u2B96\\u2B97\\u2BBA-\\u2BBC\\u2BC9\\u2BD2-\\u2BEB\\u2BF0-\\u2BFF\\u2C2F\\u2C5F\\u2CF4-\\u2CF8\\u2D26\\u2D28-\\u2D2C\\u2D2E\\u2D2F\\u2D68-\\u2D6E\\u2D71-\\u2D7E\\u2D97-\\u2D9F\\u2DA7\\u2DAF\\u2DB7\\u2DBF\\u2DC7\\u2DCF\\u2DD7\\u2DDF\\u2E43-\\u2E7F\\u2E9A\\u2EF4-\\u2EFF\\u2FD6-\\u2FEF\\u2FFC-\\u2FFF\\u3040\\u3097\\u3098\\u3100-\\u3104\\u312E-\\u3130\\u318F\\u31BB-\\u31BF\\u31E4-\\u31EF\\u321F\\u32FF\\u4DB6-\\u4DBF\\u9FD6-\\u9FFF\\uA48D-\\uA48F\\uA4C7-\\uA4CF\\uA62C-\\uA63F\\uA6F8-\\uA6FF\\uA7AE\\uA7AF\\uA7B8-\\uA7F6\\uA82C-\\uA82F\\uA83A-\\uA83F\\uA878-\\uA87F\\uA8C5-\\uA8CD\\uA8DA-\\uA8DF\\uA8FE\\uA8FF\\uA954-\\uA95E\\uA97D-\\uA97F\\uA9CE\\uA9DA-\\uA9DD\\uA9FF\\uAA37-\\uAA3F\\uAA4E\\uAA4F\\uAA5A\\uAA5B\\uAAC3-\\uAADA\\uAAF7-\\uAB00\\uAB07\\uAB08\\uAB0F\\uAB10\\uAB17-\\uAB1F\\uAB27\\uAB2F\\uAB66-\\uAB6F\\uABEE\\uABEF\\uABFA-\\uABFF\\uD7A4-\\uD7AF\\uD7C7-\\uD7CA\\uD7FC-\\uF8FF\\uFA6E\\uFA6F\\uFADA-\\uFAFF\\uFB07-\\uFB12\\uFB18-\\uFB1C\\uFB37\\uFB3D\\uFB3F\\uFB42\\uFB45\\uFBC2-\\uFBD2\\uFD40-\\uFD4F\\uFD90\\uFD91\\uFDC8-\\uFDEF\\uFDFE\\uFDFF\\uFE1A-\\uFE1F\\uFE53\\uFE67\\uFE6C-\\uFE6F\\uFE75\\uFEFD-\\uFF00\\uFFBF-\\uFFC1\\uFFC8\\uFFC9\\uFFD0\\uFFD1\\uFFD8\\uFFD9\\uFFDD-\\uFFDF\\uFFE7\\uFFEF-\\uFFFB\\uFFFE\\uFFFF',\n  'P': '\\x21-\\x23\\x25-\\\\x2A\\x2C-\\x2F\\x3A\\x3B\\\\x3F\\x40\\\\x5B-\\\\x5D\\x5F\\\\x7B\\x7D\\xA1\\xA7\\xAB\\xB6\\xB7\\xBB\\xBF\\u037E\\u0387\\u055A-\\u055F\\u0589\\u058A\\u05BE\\u05C0\\u05C3\\u05C6\\u05F3\\u05F4\\u0609\\u060A\\u060C\\u060D\\u061B\\u061E\\u061F\\u066A-\\u066D\\u06D4\\u0700-\\u070D\\u07F7-\\u07F9\\u0830-\\u083E\\u085E\\u0964\\u0965\\u0970\\u0AF0\\u0DF4\\u0E4F\\u0E5A\\u0E5B\\u0F04-\\u0F12\\u0F14\\u0F3A-\\u0F3D\\u0F85\\u0FD0-\\u0FD4\\u0FD9\\u0FDA\\u104A-\\u104F\\u10FB\\u1360-\\u1368\\u1400\\u166D\\u166E\\u169B\\u169C\\u16EB-\\u16ED\\u1735\\u1736\\u17D4-\\u17D6\\u17D8-\\u17DA\\u1800-\\u180A\\u1944\\u1945\\u1A1E\\u1A1F\\u1AA0-\\u1AA6\\u1AA8-\\u1AAD\\u1B5A-\\u1B60\\u1BFC-\\u1BFF\\u1C3B-\\u1C3F\\u1C7E\\u1C7F\\u1CC0-\\u1CC7\\u1CD3\\u2010-\\u2027\\u2030-\\u2043\\u2045-\\u2051\\u2053-\\u205E\\u207D\\u207E\\u208D\\u208E\\u2308-\\u230B\\u2329\\u232A\\u2768-\\u2775\\u27C5\\u27C6\\u27E6-\\u27EF\\u2983-\\u2998\\u29D8-\\u29DB\\u29FC\\u29FD\\u2CF9-\\u2CFC\\u2CFE\\u2CFF\\u2D70\\u2E00-\\u2E2E\\u2E30-\\u2E42\\u3001-\\u3003\\u3008-\\u3011\\u3014-\\u301F\\u3030\\u303D\\u30A0\\u30FB\\uA4FE\\uA4FF\\uA60D-\\uA60F\\uA673\\uA67E\\uA6F2-\\uA6F7\\uA874-\\uA877\\uA8CE\\uA8CF\\uA8F8-\\uA8FA\\uA8FC\\uA92E\\uA92F\\uA95F\\uA9C1-\\uA9CD\\uA9DE\\uA9DF\\uAA5C-\\uAA5F\\uAADE\\uAADF\\uAAF0\\uAAF1\\uABEB\\uFD3E\\uFD3F\\uFE10-\\uFE19\\uFE30-\\uFE52\\uFE54-\\uFE61\\uFE63\\uFE68\\uFE6A\\uFE6B\\uFF01-\\uFF03\\uFF05-\\uFF0A\\uFF0C-\\uFF0F\\uFF1A\\uFF1B\\uFF1F\\uFF20\\uFF3B-\\uFF3D\\uFF3F\\uFF5B\\uFF5D\\uFF5F-\\uFF65',\n  'S': '\\\\x24\\\\x2B\\x3C-\\x3E\\\\x5E\\x60\\\\x7C\\x7E\\xA2-\\xA6\\xA8\\xA9\\xAC\\xAE-\\xB1\\xB4\\xB8\\xD7\\xF7\\u02C2-\\u02C5\\u02D2-\\u02DF\\u02E5-\\u02EB\\u02ED\\u02EF-\\u02FF\\u0375\\u0384\\u0385\\u03F6\\u0482\\u058D-\\u058F\\u0606-\\u0608\\u060B\\u060E\\u060F\\u06DE\\u06E9\\u06FD\\u06FE\\u07F6\\u09F2\\u09F3\\u09FA\\u09FB\\u0AF1\\u0B70\\u0BF3-\\u0BFA\\u0C7F\\u0D79\\u0E3F\\u0F01-\\u0F03\\u0F13\\u0F15-\\u0F17\\u0F1A-\\u0F1F\\u0F34\\u0F36\\u0F38\\u0FBE-\\u0FC5\\u0FC7-\\u0FCC\\u0FCE\\u0FCF\\u0FD5-\\u0FD8\\u109E\\u109F\\u1390-\\u1399\\u17DB\\u1940\\u19DE-\\u19FF\\u1B61-\\u1B6A\\u1B74-\\u1B7C\\u1FBD\\u1FBF-\\u1FC1\\u1FCD-\\u1FCF\\u1FDD-\\u1FDF\\u1FED-\\u1FEF\\u1FFD\\u1FFE\\u2044\\u2052\\u207A-\\u207C\\u208A-\\u208C\\u20A0-\\u20BE\\u2100\\u2101\\u2103-\\u2106\\u2108\\u2109\\u2114\\u2116-\\u2118\\u211E-\\u2123\\u2125\\u2127\\u2129\\u212E\\u213A\\u213B\\u2140-\\u2144\\u214A-\\u214D\\u214F\\u218A\\u218B\\u2190-\\u2307\\u230C-\\u2328\\u232B-\\u23FA\\u2400-\\u2426\\u2440-\\u244A\\u249C-\\u24E9\\u2500-\\u2767\\u2794-\\u27C4\\u27C7-\\u27E5\\u27F0-\\u2982\\u2999-\\u29D7\\u29DC-\\u29FB\\u29FE-\\u2B73\\u2B76-\\u2B95\\u2B98-\\u2BB9\\u2BBD-\\u2BC8\\u2BCA-\\u2BD1\\u2BEC-\\u2BEF\\u2CE5-\\u2CEA\\u2E80-\\u2E99\\u2E9B-\\u2EF3\\u2F00-\\u2FD5\\u2FF0-\\u2FFB\\u3004\\u3012\\u3013\\u3020\\u3036\\u3037\\u303E\\u303F\\u309B\\u309C\\u3190\\u3191\\u3196-\\u319F\\u31C0-\\u31E3\\u3200-\\u321E\\u322A-\\u3247\\u3250\\u3260-\\u327F\\u328A-\\u32B0\\u32C0-\\u32FE\\u3300-\\u33FF\\u4DC0-\\u4DFF\\uA490-\\uA4C6\\uA700-\\uA716\\uA720\\uA721\\uA789\\uA78A\\uA828-\\uA82B\\uA836-\\uA839\\uAA77-\\uAA79\\uAB5B\\uFB29\\uFBB2-\\uFBC1\\uFDFC\\uFDFD\\uFE62\\uFE64-\\uFE66\\uFE69\\uFF04\\uFF0B\\uFF1C-\\uFF1E\\uFF3E\\uFF40\\uFF5C\\uFF5E\\uFFE0-\\uFFE6\\uFFE8-\\uFFEE\\uFFFC\\uFFFD'\n};\n\nfunction sanitizeTyping(text, strict) {\n  text = text.trim()\n             .replace(/\\s+/g, \" \")\n             .replace(new RegExp(RegexUnicode.C, \"g\"), \"\"); // control chars\n\n  // https://cdnjs.cloudflare.com/ajax/libs/xregexp/3.1.1/xregexp-all.js\n  if(!strict) {\n    text = text.replace(/\\(.*?\\)/g, \"\")\n               .replace(new RegExp('[' + RegexUnicode.P + RegexUnicode.S + ']', \"g\"), \"\") // punctuation, symbol\n               .replace(/[-Ù‹Ù›]+/g, \"\")\n               .replace(/\\s+/g, \" \");\n  }\n  return text;\n}\n\nfunction calculate_points_learn(score) {\n  return 1 === score ? 45 : 0 === score ? 0 : Math.max(10, Math.round(45 * score) - 20);\n}\nfunction calculate_points_speed(time_spent) {\n  var t = Math.floor(time_spent / 1e3);\n  return t >= 6 ? Math.min(15, 25) : Math.min(15 + 7 * (6 - t), 25);\n}\nfunction calculate_points_review(points, current_streak) {\n  points *= Math.pow(1.2, current_streak);\n  points  = Math.min(points, 150);\n  return Math.ceil(points);\n}\n\nfunction calculate_speed_bonus(time_spent, tpl) {\n  if(tpl == \"typing\") {\n    return time_spent < 4e3 ? 5 : 0;\n  } else {\n    return time_spent < 2e3 ? 3 : 0;\n  }\n}\nfunction calculate_accuracy_bonus(percent_correct, num_scheduled_correct) {\n  if(percent_correct == 100) {\n    return 20 * num_scheduled_correct;\n\n  } else if(percent_correct >= 90) {\n    return 12 * num_scheduled_correct;\n\n  } else if(percent_correct >= 80) {\n    return 6 * num_scheduled_correct;\n\n  } else if(percent_correct >= 70) {\n    return 4 * num_scheduled_correct;\n\n  } else if(percent_correct >= 50) {\n    return 2 * num_scheduled_correct;\n\n  } else {\n    return 0;\n  }\n}\n\n//+--------------------------------------------------------\n//| HIGHLIGHT TEXT DIFF\n//+--------------------------------------------------------\n\n// https://codereview.stackexchange.com/questions/133586/a-string-prototype-diff-implementation-text-diff\n// https://codereview.stackexchange.com/questions/133586/a-string-prototype-diff-implementation-text-diff\nvar diff = (function(){\n\n  function rotate(arr, n){\n    var len = arr.length;\n    if (n % len === 0) {\n      return arr.slice();\n    }\n    var res = new Array(arr.length)\n    for (var i = 0; i < len; i++) {\n      res[i] = arr[(i + (len + n % len)) % len];\n    }\n    return res;\n  };\n\n  // returns the first matching substring in-between the two strings\n  function getMatchingSubstring(s,l,m){\n    var i     = -1,\n        n     = s.length,\n        match = false,\n        cd     = {fis:n, mtc:m, sbs:\"\"}; // temporary object used to construct the cd (change data) object\n\n    while (++i < n) {\n      if(l[i] === s[i]) {\n        if(match) {\n          cd.sbs += s[i]; // o.sbs holds the matching substring itsef\n        } else {\n          match = true;\n          cd.fis = i;\n          cd.sbs = s[i];\n        }\n      } else if(match) {\n        break; // stop after the first found substring\n      }\n    }\n    return cd;\n  }\n\n  function getChanges(t,s,m,p){\n    var isThisLonger, longer, shorter;\n\n    // assignment of longer and shorter\n    if(t.length >= s.length) {\n      isThisLonger = true;\n      longer       = t;\n      shorter      = s;\n    } else {\n      isThisLonger = false;\n      longer       = s;\n      shorter      = t;\n    }\n\n    // get the index of first mismatching character in both strings\n    var base_index = 0;\n    while(shorter[base_index] === longer[base_index] && base_index < shorter.length) {\n      base_index++;\n    }\n\n    // convert longer to array to be able to rotate it\n    // shorter and longer now starts from the first mismatching character\n    longer  = longer.split(\"\").slice(base_index);\n    shorter = shorter.slice(base_index);\n\n    var len = longer.length,                   // length of the longer string\n        cd = {fis: shorter.length,             // the index of matching string in the shorter string\n              fil: len,                        // the index of matching string in the longer string\n              sbs: \"\",                         // the matching substring itself\n              mtc: m + s.slice(0,base_index)}, // if exists mtc holds the matching string at the front\n        sub = {sbs:\"\"};                       // returned substring per 1 character rotation of the longer string\n\n    if(shorter !== \"\") {\n      for(var rc = 0; rc < len && sub.sbs.length < p; rc++){             // rc -> rotate count, p -> precision factor\n        sub = getMatchingSubstring(shorter, rotate(longer, rc), cd.mtc); // rotate longer string 1 char and get substring\n        sub.fil = rc < len - sub.fis ? sub.fis + rc                      // mismatch is longer than the mismatch in short\n                                     : sub.fis - len + rc;               // mismatch is shorter than the mismatch in short\n        sub.sbs.length > cd.sbs.length && (cd = sub);                    // only keep the one with the longest substring.\n      }\n    }\n\n    // insert the mismatching delete subsrt and insert substr to the cd object and attach the previous substring\n    if(isThisLonger) {\n      cd.del = longer.slice(0,cd.fil).join(\"\");\n      cd.ins = shorter.slice(0,cd.fis);\n    } else {\n      cd.del = shorter.slice(0,cd.fis);\n      cd.ins = longer.slice(0,cd.fil).join(\"\");\n    }\n\n    if(cd.del.indexOf(\" \") == -1 || cd.ins.indexOf(\" \") == -1) return cd;\n    if(cd.del === \"\" || cd.ins === \"\" || cd.sbs === \"\") return cd;\n    return getChanges(cd.del, cd.ins, cd.mtc, p);\n  }\n\n  function diff(txt1, txt2, p){\n    p = p || 2; // p -> precision factor\n\n    var cd       = getChanges(txt1,txt2,\"\",p),\n        nextTxt2 = txt2.slice(cd.mtc.length + cd.ins.length + cd.sbs.length), // remaining part of \"txt2\"\n        nextTxt1 = txt1.slice(cd.mtc.length + cd.del.length + cd.sbs.length), // remaining part of \"txt1\"\n        result   = \"\";                                                        // the glorious result\n\n    cd.del.length > 0 && (cd.del = '<span class = \"deleted\">'  + cd.del + '</span>');\n    cd.ins.length > 0 && (cd.ins = '<span class = \"inserted\">' + cd.ins + '</span>');\n    result = cd.mtc + cd.del + cd.ins + cd.sbs;\n\n    if(nextTxt1 !== \"\" || nextTxt2 !== \"\") {\n      result += diff(nextTxt1,nextTxt2,p);\n    }\n    return result;\n  };\n\n  return diff;\n})();"]}