{"version":3,"sources":["../js6/edit.js"],"names":["h","Component","render","window","preact","$","document","ready","Object","freeze","course","getElementById","Edit","constructor","props","setNewRow","bind","new_row","bindEvents","opentab","location","hash","match","levels","map","level","i","show","id","EditLevel","state","toggle","componentDidMount","getData","data","setState","ajax","url","success","pool","div","rendered","get","outerHTML","find","last","i18n","_export","__html","_import","name","isInit","focused","altInit","init","on","focus_input","blur_input_adding","focus_lastRow","click_cell","type_cell","blur_input_thing","click_saveMultimedia","click_editAlt","send_file","click_displayFiles","click_removeFile","click_deleteRow","click_export","send_import","$tr","closest","empty","each","val","setTimeout","is","addClass","addRow","uploads","$level","idLevel","method","csrftoken","referer","JSON","stringify","json","html","rendered_thing","$newTr","appendTo","File","downloadFromUrls","remove","error","xhr","console","thingId","length","upload","cellId","$column","children","downloadFromUrl","mime","fetch","then","res","blob","file","type","uploadFile","append","firstElementChild","input","createElement","value","innerHTML","className","appendChild","focus","e","which","target","$nextTr","next","first","trigger","preventDefault","$btn","alts","thing","columns","alt","join","modal","open","bindAltEvents","close","click_altAction","click_altSave","$alt","$alts","trim","push","confirm","removeRow","thingid","levelid","id_thing","txt","$div","parentNode","text","updateCell","cellValue","alert","files","fd","FormData","processData","contentType","message","replaceWith","nextElementSibling","replace","removeFile","fileId","attr","prev","removeAttr","$table","row","csvContent","exportCsv","$col","hasClass","list","$item","filename","substring","lastIndexOf","download","title","import_err_ext","reader","FileReader","onload","f","import_file","result","readAsText","content","csv","toArrays","$adding","table_headers","table_keys","types","toLowerCase","headers","header","k","indexOf","key","rows","row_import","row_upload","j","split","l","item","ext","import_preview","import_err_empty","assign","onclose","run_import","container","one","import_rows","fileName","mimeType","a","navigator","msSaveBlob","Blob","URL","href","createObjectURL","setAttribute","body","click","removeChild","encodeURIComponent"],"mappings":"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","file":"edit.js","sourcesContent":["/** @jsx h */\n'use strict';\nconst {h, Component, render} = window.preact;\n\n/* global $ */\n/* global navigator, Blob, URL, File, fetch */\n\n$(document).ready(function(){\n  Object.freeze(window.course);\n\n  render(<Edit course={window.course} />, document.getElementById('edit-levels'));\n});\n\n//+--------------------------------------------------------\n//| Render Levels\n//+--------------------------------------------------------\n\nclass Edit extends Component {\n  constructor(props) {\n    super(props);\n    this.setNewRow = this.setNewRow.bind(this);\n  }\n\n  setNewRow(new_row) {\n    this.new_row = new_row;\n    bindEvents(new_row);\n  }\n\n  render() {\n    var opentab = window.location.hash.match(/#(i|l)_(\\d+)/);\n\n    return <div>\n      {window.course.levels.map((level, i) => {\n        var show = false;\n        if(opentab) {\n          if(opentab[1] == \"i\") {\n            show = (i+1 == opentab[2]);\n          } else {\n            show = (level.id == opentab[2]);\n          }\n        }\n        return <EditLevel show={show} key={i} level={level} setNewRow={this.setNewRow} />;\n      })}\n    </div>;\n  }\n}\n\nclass EditLevel extends Component {\n  constructor(props) {\n    super(props);\n\n    this.state = {\"show\": false};\n    this.toggle = this.toggle.bind(this);\n  }\n\n  componentDidMount() {\n    if(this.props.show) {\n      this.getData();\n    }\n  }\n\n  toggle() {\n    if(!this.state.show && !this.data) {\n      this.getData();\n\n    } else {\n      this.setState({\n        show: !this.state.show\n      });\n    }\n  }\n\n  getData() {\n    $.ajax({\n      url: \"/ajax/level/\" + this.props.level.id,\n      success: function(data){\n        if(this.props.level.pool) {\n          var div = $('.table-container', data.rendered);\n\n          this.data    = div.get(0).outerHTML;\n          this.props.setNewRow(div.find('tr').last().get(0).outerHTML);\n\n        } else {\n          this.data = $('.level-multimedia', data.rendered).get(0).outerHTML;\n        }\n        this.setState({\n          show: true\n        });\n      }.bind(this)\n    });\n  }\n\n  render() {\n    var level = this.props.level;\n\n    return <div class={\"edit-level nicebox\" + (this.state.show ? \"\" : \" collapsed\")} data-level-id={level.id} data-pool-id={level.pool || \"\"}>\n      <div class=\"edit-level-actions\">\n        {this.state.show\n          && <label class=\"export action\" title={window.i18n._export}>\n              <i dangerouslySetInnerHTML={{__html: '&darr;'}} />\n            </label>}\n        {this.state.show\n          && <label class=\"import action\" title={window.i18n._import} for={\"import_\" + level.id}>\n              <input type=\"file\" id={\"import_\" + level.id} />\n              <i dangerouslySetInnerHTML={{__html: '&uarr;'}} />\n            </label>}\n        <label class=\"toggle action\" onClick={this.toggle} dangerouslySetInnerHTML={{__html: '&updownarrow;'}} />\n      </div>\n\n      <div class=\"edit-level-label\">\n        <label>{level.name}</label>\n        {!level.pool && <span>&nbsp;(multimedia)</span>}\n      </div>\n\n      {this.state.show && <div dangerouslySetInnerHTML={{__html: this.data}}></div>}\n    </div>;\n  }\n}\n\n//+--------------------------------------------------------\n//| Events\n//+--------------------------------------------------------\n\nvar isInit  = false,\n    focused = false,\n    altInit = false;\n\nfunction bindEvents(new_row) {\n  if(isInit) {\n    return;\n  }\n  isInit = true;\n  init();\n\n  function init() {\n    $('#edit-levels')\n\n    // New row\n    .on('focus', 'input', focus_input)\n    .on('blur', '.adding input.wide', blur_input_adding)\n    .on('focus', '.adding tr:last-child input.wide', focus_lastRow)\n\n    // Update cell\n    .on('click', 'div.text', click_cell)\n    .on('keyup', 'input.wide', type_cell)\n    .on('blur', '.things input.wide', blur_input_thing)\n\n    .on('click', '.multimedia-edit button', click_saveMultimedia)\n\n    // Update alternatives\n    .on('click', '.edit-alts', click_editAlt)\n\n    // Update attachments\n    .on('change', '.things input[type=\"file\"]', send_file)\n    .on('click', '.dropdown-toggle', click_displayFiles)\n    .on('click', '.dropdown-row .ico-trash', click_removeFile)\n\n    // Delete row\n    .on('click', '.ico-close', click_deleteRow)\n    \n    // Import/export\n    .on('click', '.export', click_export)\n    .on('change', '.import input', send_import);\n  }\n\n  //+---------------------------------------------------------------------------\n  // Remember current input focused\n  function focus_input() {\n    focused = this;\n  }\n\n  //+---------------------------------------------------------------------------\n  // On blur cell in adding tbody: add row\n  function blur_input_adding() {\n    focused = false;\n\n    // Retrieve the row datas\n    var $tr  = $(this).closest('tr'),\n        data = {},\n        empty = true;\n\n    $tr.find('td[data-key]').each(function(){\n      var val = $(this).find('input').val();\n      if(val) {\n        empty = false;\n      }\n      data[$(this).data('key')] = val;\n    });\n    if(empty) {\n      return;\n    }\n\n    // Check if we changed row or just cell of the row\n    setTimeout(function(){\n      if(focused && $(focused).closest('tr').is($tr)) {\n        return;\n      }\n      $tr.addClass('disabled');\n      addRow($tr, data);\n    },100);\n  }\n\n  // POST new row\n  function addRow($tr, data, uploads){\n    var $level  = $tr.closest('.edit-level'),\n        idLevel = $level.data('level-id');\n\n    $.ajax({\n      url: \"/ajax/level/\" + idLevel + \"/add\",\n      method: \"POST\",\n      data: {\n        csrftoken: window.course.csrftoken,\n        referer: window.course.referer,\n        data: JSON.stringify(data)\n      },\n      success: function(json){\n        var html   = json.rendered_thing,\n            $newTr = $(html).appendTo($('.things', $level));\n\n        if(uploads && window.File) {\n          downloadFromUrls($newTr, idLevel, uploads);\n        }\n        $tr.remove();\n      },\n      error: function(xhr){\n        console.error(xhr);\n        $tr.remove('disabled');\n      }\n    });\n  }\n\n  // Import rows: handle file upload from URL\n  function downloadFromUrls($tr, idLevel, uploads) {\n    var thingId = $tr.data('thing-id');\n\n    for(var i=0; i<uploads.length; i++) {\n      var upload  = uploads[i],\n          cellId  = upload[0],\n          $column = $tr.children('[data-key=\"' + cellId + '\"]');\n\n      downloadFromUrl($column, thingId, cellId, upload);\n    }\n  }\n  function downloadFromUrl($column, thingId, cellId, upload) {\n    var name    = upload[1],\n        url     = upload[2],\n        mime    = upload[3];\n\n    fetch(url)\n      .then(res => res.blob())\n      .then(blob => {\n          var file = new File([blob], name, {type: mime});\n\n          uploadFile($column, cellId, thingId, file);\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  // Focus last row: add a new row\n  function focus_lastRow(){\n    $(this).closest('.adding').append(new_row);\n  }\n\n  //+---------------------------------------------------------------------------\n  // Click on cell: display input\n  function click_cell() {\n    if(this.firstElementChild) {\n      return;\n    }\n    var input       = document.createElement('input');\n    input.value     = this.innerHTML;\n    input.type      = \"text\";\n    input.className = \"wide\";\n    this.appendChild(input);\n    input.focus();\n  }\n\n  //+---------------------------------------------------------------------------\n  // On enter: focus next row\n  function type_cell(e){\n    if(e.which != 13) {\n      return;\n    }\n    var $tr     = $(e.target).closest('tr'),\n        $nextTr = $tr.next('tr');\n\n    if($nextTr.length == 0) {\n      $nextTr = $tr.closest('tbody').next('tbody').children(':not(.header)').first();\n      $nextTr.find('input.wide').first().focus();\n    } else {\n      $nextTr.find('div.text, input.wide').first().trigger('click').focus();\n    }\n  }\n\n  //+---------------------------------------------------------------------------\n  // On click \"alternatives\": edit alternatives\n  function click_editAlt(e) {\n    e.preventDefault();\n\n    var $btn    = $(e.target),\n        thingId = $btn.closest('.thing').data('thing-id'),\n        cellId  = $btn.closest('.column').data('key');\n\n    $.ajax({\n      url: \"/ajax/level/\" + thingId + \"/alt\",\n      method: \"POST\",\n      data: {\n        csrftoken: window.course.csrftoken,\n        referer: window.course.referer\n      },\n      success: function(data) {\n        var alts = data.thing.columns[cellId].alts,\n            html = `<div class=\"alts\">\n          ${alts.map((alt) => `<div class=\"alt\">\n            <input type=\"text\" name=\"${alt.id}\" value=\"${alt.val}\" />\n            <button type=\"button\" class=\"alt-action\"></button>\n          </div>`).join('')}\n\n          <div class=\"alt\">\n            <input type=\"text\" value=\"\" />\n            <button type=\"button\" class=\"alt-action\"></button>\n          </div>\n        </div>\n\n        <div class=\"alt-actions\">\n          <button class=\"btn alt-cancel\">Annuler</button>\n          <button class=\"btn active alt-save\" data-cell=\"${cellId}\" data-thing=${thingId}>Sauvegarder</button>\n        </div>`;\n\n        window.modal.open(html);\n        bindAltEvents();\n      }\n    });\n  }\n\n  function bindAltEvents() {\n    if(altInit) {\n      return;\n    }\n    altInit = true;\n\n    $('#modal')\n    .on('click', '.alt-cancel', function(){ window.modal.close(); })\n    .on('click', '.alt-action', click_altAction)\n    .on('click', '.alt-save', click_altSave);\n  }\n\n  // Click alt action: last row = add new, others = remove current\n  function click_altAction() {\n    var $alt  = $(this).closest('.alt'),\n        $alts = $(this).closest('.alts');\n\n    if($alts.children().last().is($alt)) {\n      $alts.append(`<div class=\"alt\">\n        <input type=\"text\" value=\"\" />\n        <button type=\"button\" class=\"alt-action\"></button>\n      </div>`);\n    } else {\n      $alt.remove();\n    }\n  }\n\n  // Click alt save: save modal content and close\n  function click_altSave() {\n    var cellId  = $(this).data('cell'),\n        thingId = $(this).data('thing'),\n        alts    = [];\n\n    $('#modal input').each(function(){\n      if(this.value.trim()) {\n        alts.push(this.value.trim());\n      }\n    });\n\n    $.ajax({\n      url: \"/ajax/level/\" + thingId + \"/alt_edit\",\n      method: \"POST\",\n      data: {\n        csrftoken: window.course.csrftoken,\n        referer: window.course.referer,\n        alts: JSON.stringify(alts),\n        cellId: cellId\n      },\n      success: function(data) {\n        window.modal.close();\n      }\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  // On click \"delete\": delete row\n  function click_deleteRow(e){\n    e.preventDefault();\n    if(confirm('Delete this row ?')) {\n      removeRow($(e.target).closest('tr'));\n    }\n  }\n\n  function removeRow($tr){\n    var $level  = $tr.closest('.edit-level'),\n        thingid = $tr.data('thing-id'),\n        levelid = $level.data('level-id');\n\n    $.ajax({\n      url: \"/ajax/level/\" + levelid + \"/remove\",\n      method: \"POST\",\n      data: {\n        csrftoken: window.course.csrftoken,\n        referer: window.course.referer,\n        id_thing: thingid\n      },\n      success: function(json){\n        $tr.remove();\n      },\n      error: function(xhr){\n        console.error(xhr);\n        $tr.remove('disabled');\n      }\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  // On blur cell in things tbody: update cell\n  function blur_input_thing(){\n    var txt  = this.value.trim(),\n        $div = $(this.parentNode);\n\n    if(txt == $div.text()) {\n      $div.text(txt);\n      return;\n    }\n    $div.text(txt);\n\n    var thingId = $div.closest('.thing').data('thing-id'),\n        cellId  = $div.closest('.column').data('key');\n\n    updateCell(thingId, cellId, txt);\n  }\n\n  // POST new cell value\n  function updateCell(thingId, cellId, cellValue) {\n    $.ajax({\n      url: \"/ajax/level/\" + thingId + \"/edit\",\n      method: \"POST\",\n      data: {\n        csrftoken: window.course.csrftoken,\n        referer: window.course.referer,\n        cellId: cellId,\n        cellValue: cellValue\n      },\n      error: function(){\n        alert('Something went wrong when trying to update cell');\n      }\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  // On send file: upload file\n  function send_file(e){\n    var $column = $(this).closest('.column'),\n        cellId  = $column.data('key'),\n        thingId = $(this).closest('.thing').data('thing-id'),\n        file    = this.files[0];\n\n    uploadFile($column, cellId, thingId, file);\n  }\n\n  function uploadFile($column, cellId, thingId, file) {\n    var fd = new FormData();\n    fd.append('file', file);\n    fd.append('csrftoken', window.course.csrftoken);\n    fd.append('referer', window.course.referer);\n    fd.append('cellId', cellId);\n\n    $.ajax({\n      url: '/ajax/level/' + thingId + '/upload',\n      data: fd,\n      processData: false,\n      contentType: false,\n      type: 'POST',\n      success: function(data){\n        if(data.message) {\n          alert(data.message);\n        }\n        $column.replaceWith(data.rendered);\n      }\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  // On click files: display attachments\n  function click_displayFiles(e) {\n    var div = e.target.nextElementSibling;\n    div.innerHTML = div.innerHTML.replace(/ src=\"#\"/g, '')\n                                 .replace(/ data-url=\"/g, ' src=\"');\n  }\n\n  //+---------------------------------------------------------------------------\n  // On click remove file: remove attachment\n  function click_removeFile(e){\n    removeFile($(e.target));\n  }\n\n  function removeFile($btn) {\n    var fileId  = $btn.closest('.dropdown-row').data('file-id'),\n        $column = $btn.closest('.column'),\n        cellId  = $column.data('key'),\n        thingId = $btn.closest('.thing').data('thing-id');\n\n    $.ajax({\n      url: '/ajax/level/' + thingId + '/upload_remove',\n      data: {\n        \"csrftoken\": window.course.csrftoken,\n        \"referer\": window.course.referer,\n        \"cellId\": cellId,\n        \"fileId\": fileId\n      },\n      type: 'POST',\n      success: function(data){\n        if(data.message) {\n          alert(data.message);\n        }\n        $column.replaceWith(data.rendered);\n      }\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  // On click save: update multimedia content\n  function click_saveMultimedia() {\n    var $btn = $(this);\n    $btn.attr('disabled', 'disabled');\n\n    var idLevel = $btn.closest('.edit-level').data('level-id');\n    $.ajax({\n      url: \"/ajax/level/\" + idLevel + \"/edit_multimedia\",\n      method: \"POST\",\n      data: {\n        csrftoken: window.course.csrftoken,\n        referer: window.course.referer,\n        txt: $btn.prev().val()\n      },\n      success: function(){\n        $btn.removeAttr('disabled');\n      }\n    });\n  }\n\n  //+---------------------------------------------------------------------------\n  function click_export() {\n    var $level     = $(this).closest('.edit-level'),\n        idLevel    = $level.data('level-id'),\n        $table     = $level.find('table'),\n        row        = [],\n        csvContent = \"\";\n\n    // Get headers\n    $table.children('.columns').find('.column,.attribute').each(function(){\n      row.push($(this).text().trim());\n    });\n    csvContent += exportCsv(row);\n\n    // Get rows\n    $table.children('.things').children().each(function(){\n      var empty = true;\n\n      row = [];\n\n      // Get columns\n      $(this).children('.column,.attribute').each(function(){\n        var $col = $(this),\n            txt  = \"\";\n\n        // Text\n        if($col.hasClass('text')) {\n          txt = $col.find('.text').text().trim();\n\n        // Image attachment\n        } else if($col.hasClass('image')) {\n          var list = [];\n\n          // Get list of images\n          $col.find('.images').children('.dropdown-row').each(function(){\n            var $item = $(this).find('img'),\n                url   = $item.attr('data-url');\n\n            if(!url) {\n              url = $item.attr('src');\n            }\n            if(url && url != \"#\") {\n              var filename = url.substring(url.lastIndexOf('/')+1);\n              list.push(filename + ' (' + url + ')');\n            }\n          });\n          txt = list.join(',');\n\n        } else if($col.hasClass('audio')) {\n          var list = [];\n\n          // Get list of audios\n          $col.find('.audios').children('.dropdown-row').each(function(){\n            var $item = $(this).find('a'),\n                url   = $item.attr('data-url');\n\n            if(!url) {\n              url = $item.attr('src');\n            }\n            if(url && url != \"#\") {\n              var filename = url.substring(url.lastIndexOf('/')+1);\n              list.push(filename + ' (' + url + ')');\n            }\n          });\n          txt = list.join(',');\n        }\n\n        // Add column to row\n        if(txt) {\n          empty = false;\n        }\n        row.push(txt);\n      });\n\n      // Export row\n      if(!empty) {\n        csvContent += exportCsv(row);\n      }\n    });\n    download(csvContent, window.course.title + '_' + idLevel + '.csv', 'text/csv;encoding:utf-8');\n  }\n\n  function send_import(e) {\n    if(!e.target.files) {\n      return;\n    }\n    var file = e.target.files[0];\n    if(file.type != \"text/csv\") {\n      alert(window.i18n.import_err_ext);\n      return;\n    }\n\n    var reader = new FileReader(),\n        $level = $(this).closest('.edit-level');\n    reader.onload = (function(f) {\n      return function(e) {\n        import_file($level, e.target.result);\n      };\n    })(file);\n\n    reader.readAsText(file);\n  }\n\n  function import_file($level, content) {\n    var data = $.csv.toArrays(content);\n    if(!data.length) {\n      return;\n    }\n\n    var $table        = $level.find('table'),\n        $adding       = $table.children('.adding'),\n        table_headers = [],\n        table_keys    = [],\n        types         = [];\n\n    // Get table headers\n    $table.children('.columns').find('.column,.attribute').each(function(){\n      var $col = $(this),\n          type = \"text\";\n\n      if($col.hasClass(\"image\")) {\n        type = \"image\";\n      } else if($col.hasClass(\"audio\")) {\n        type = \"audio\";\n      }\n      types.push(type);\n\n      table_headers.push($col.text().trim().toLowerCase());\n      table_keys.push($col.data('key'));\n    });\n\n    // Get position of headers in CSV\n    var headers = [],\n        empty   = true;\n    for(var i=0; i<data[0].length; i++) {\n      var header = data[0][i].trim(),\n          k      = table_headers.indexOf(header.toLowerCase());\n\n      if(k==-1) {\n        headers.push(0);\n      } else {\n        empty = false;\n        headers.push({key: table_keys[k], type: types[k], txt: header});\n      }\n    }\n    table_headers = null;\n    table_keys    = null;\n    types         = null;\n\n    // Format rows\n    var rows = [];\n\n    if(!empty) {\n      for(var i=1; i<data.length; i++) {\n        var row        = data[i],\n            row_import = {},\n            row_upload = [];\n\n        // Get row content in the right order\n        for(var j=0; j<row.length; j++) {\n          if(!headers[j]) {\n            continue;\n          }\n          var txt = row[j].trim();\n          if(!txt) {\n            continue;\n          }\n\n          // Add its value\n          var cellId = headers[j].key,\n              type   = headers[j].type;\n\n          if(type == \"text\") {\n            row_import[cellId] = txt;\n  \n          // Upload its attachments once added\n          } else {\n            var list = txt.split(\",\");\n\n            for(var l=0; l<list.length; l++) {\n              var item  = list[l],\n                  match = item.match(/^([^(]+)\\(([^)]+)\\)$/);\n\n              if(!match) {\n                continue;\n              }\n              var filename = match[1].trim(),\n                  mime     = \"\",\n                  ext      = filename.substring(filename.lastIndexOf('.')+1);\n\n              switch(ext) {\n                case \"png\":  mime = \"image/png\"; break;\n                case \"jpg\":  mime = \"image/jpeg\"; break;\n                case \"jpeg\": mime = \"image/jpeg\"; break;\n                case \"gif\":  mime = \"image/gif\"; break;\n                case \"mp3\":  mime = \"audio/mpeg\"; break;\n                case \"mp4\":  mime = \"video/mp4\"; break;\n                case \"aac\":  mime = \"audio/aac\"; break;\n              }\n              if(!mime) {\n                continue;\n              }\n              row_upload.push([cellId, filename, match[2].trim(), mime]);\n            }\n          }\n        }\n\n        // Create a new table row\n        rows.push({data: row_import, upload: row_upload});\n      }\n    }\n    data = null;\n\n    import_preview(rows, empty ? false : headers, $adding);\n  }\n\n  function import_preview(rows, headers, $adding) {\n    if(!headers) {\n      alert(window.i18n.import_err_empty);\n      return;\n    }\n    var html = '<div class=\"import_preview\">';\n    html += '<button class=\"btn active run_import top\">' + window.i18n._import + '</button>';\n    html += '<table>';\n\n    // Display headers\n    html += '<thead><tr>';\n    for(var i=0; i<headers.length; i++) {\n        if(!headers[i]) {\n          continue;\n        }\n      html += '<th>' + headers[i].txt + '</th>';\n    }\n    html += '</tr></thead>';\n\n    // Display rows\n    html += '<tbody>';\n    for(var i=0; i<rows.length; i++) {\n      html += '<tr>';\n\n      var row  = rows[i],\n          data = Object.assign({}, row.data);\n\n      // Bring back upload to data\n      for(var j=0; j<row.upload.length; j++) {\n        var upload  = row.upload[j],\n            cellId  = upload[0],\n            url     = upload[2];\n\n        if(typeof data[cellId] != \"undefined\") {\n          data[cellId].push(url);\n        } else {\n          data[cellId] = [url];\n        }\n      }\n\n      // Display data\n      for(var j=0; j<headers.length; j++) {\n        if(!headers[j]) {\n          continue;\n        }\n        var k       = headers[j].key,\n            type    = headers[j].type,\n            content = data[k] || \"\";\n\n        if(type == \"image\") {\n          content = content.map(function(txt){\n            return '<img src=\"' + txt + '\">';\n          }).join(\"\");\n\n        } else if(type == \"audio\") {\n          content = content.map(function(txt){\n            return '<audio src=\"' + txt + '\">';\n          }).join(\"\");\n        }\n        html += '<td>' + content + '</td>';\n      }\n      html += '</tr>';\n    }\n    html += '</tbody></table>';\n    html += '<button class=\"btn active run_import bottom\">' + window.i18n._import + '</button>';\n    html += '</div>';\n    window.modal.open(html);\n\n    // Close modal = cancel (clear out data)\n    window.modal.onclose('import', function(){\n      rows    = null;\n      headers = null;\n      $adding = null;\n\n      this.onclose('import', null);\n    });\n\n    var run_import = false;\n\n    $('.run_import', window.modal.container).one('click', function(){\n      if(run_import) {\n        return;\n      }\n      run_import = true;\n\n      window.modal.onclose('import', null);\n      window.modal.close();\n      import_rows(rows, $adding);\n\n      rows    = null;\n      headers = null;\n      $adding = null;\n    });\n  }\n\n  function import_rows(rows, $adding) {\n\n    for(var i=0; i<rows.length; i++) {\n      var data   = rows[i].data,\n          upload =rows[i].upload,\n          $tr    = $(new_row).appendTo($adding).prev().addClass('disabled');\n\n      for(var k in data) {\n        $tr.children('[data-key=\"' + k + '\"]').find('input').val(data[k]);\n      }\n      addRow($tr, data, upload);\n    }\n  }\n}\n\n/**\n * @param array row\n * @return string\n */\nfunction exportCsv(row) {\n  var txt = \"\";\n\n  for(var i=0; i<row.length; i++) {\n    if(i > 0) {\n      txt += \",\";\n    }\n    if(row[i].indexOf(',') == -1) {\n      txt += row[i];\n    } else {\n      txt += '\"' + row[i].replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\"') + '\"';\n    }\n  }\n  return txt + \"\\n\";\n}\n\n/**\n * Trigger a file download of the given mimeType\n * ex: download(csvContent, 'dowload.csv', 'text/csv;encoding:utf-8');\n * \n * @param string content\n * @param string fileName\n * @param mimeType\n */\nvar download = function(content, fileName, mimeType) {\n  var a = document.createElement('a');\n  mimeType = mimeType || 'application/octet-stream';\n\n  // IE10\n  if(navigator.msSaveBlob) {\n    navigator.msSaveBlob(new Blob([content], {\n      type: mimeType\n    }), fileName);\n\n  //html5 A[download]\n  } else if (URL && 'download' in a) {\n    a.href = URL.createObjectURL(new Blob([content], {\n      type: mimeType\n    }));\n    a.setAttribute('download', fileName);\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n\n  } else {\n    window.location.href = 'data:application/octet-stream,' + encodeURIComponent(content); // only this mime type is supported\n  }\n};"]}